{% extends 'layout.jinja2' %}

{% block title %} Results {% endblock %}

{% block styles %}
<link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.css') }}" />
<link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='css/results.css') }}" />
{% endblock %}

{% block content %}
<script>
    var analysis_id = {{analysis_id | safe }};
</script>
<div class='container'>
    <h1>Analysis Results</h1>
    <p>Analysis was run by {{config["analyst"]}} on DATE</p>
    <h2>Introduction</h2>
    <p>This is a report generated by the TransitCenter Equity Scenario Comparison Application (TESCA), which conducts a
        comparative analysis of access to opportunties across different population groups in a specified region.
    </p>
    <p>{{config["description"]}}</p>
    <p>
        We use two types of measures:
    <ul>
        <li>
            <b>Cumulative measures</b>, which sum the total number of a given destination or opportunity reachable in a
            specified timeframe. With this metric, <b>higher is typically better</b>. When viewing these measures, the
            accompanying parameter indicates the maximum travel time within which a desination is considered reachable.
            For example, a parameter of 45 indicates that the measure counts all destinations within 45 minutes as
            reachable.
        </li>
        <li>
            <b>Travel time measures</b>, which measure how long it takes to reach the nth (e.g. 1st, 3rd, etc) closest
            destination. With this metric, <b>lower is typically better</b>. When viewing these measures, the
            accompanying parameter indicates which nth closest desination was used. For example, a parameter of '2'
            indicates that the measure counts the travel time to the 2nd closest destination.
        </li>
    </ul>
    </p>
    <div class="pure-g">
        <div class="pure-u-1">
            <h2>Analysis Details</h2>
            <p>This analysis compares the following two scenarios:</p>
            <ol>
                {% for scenario in config["scenarios"] %}
                <li>
                    <p><b>{{ scenario["name"] }}</b>: {{ scenario["description"] }}</p>
                    <p>The analysis was run at {{ scenario["start_datetime"] }} and results are averaged over trips made
                        in the subsequent {{ scenario["duration"] }} minutes.
                        {% if "TRANSIT" in scenario["transit_modes"] %}
                        All modes of transit were considered in addition to walking.
                        {% else %}
                        In addition to walking, the following modes of transit were considered: {{
                        ", ".join(scenario["transit_modes"])| lower}}.
                        {% endif %}
                    </p>
                </li>
                {% endfor %}
            </ol>
        </div>
    </div>
    <div class="pure-g" class="page-break-before page-break-after">
        <div class="pure-u-1">
            <h2>Summary Map</h2>
            <p class="no-print">Click on the title to select a different map to display.</p>
            <p class="map-title">
                <select id="map-select" onchange="mapSelectionChanged()" class="pure-input-2-3">
                    {% for opportunity in config['opportunities'].keys() %}
                    {% if config['opportunities'][opportunity]['method'] == 'cumulative' %}
                    {% for parameter in config['opportunities'][opportunity]['parameters'] %}
                    <option value="{{ opportunity }}_c{{ parameter }}">Access to {{
                        config['opportunities'][opportunity]['name']
                        }} ({{
                        parameter }} minutes)</option>
                    {% endfor %}
                    {% else %}
                    {% for parameter in config['opportunities'][opportunity]['parameters'] %}
                    <option value="{{ opportunity }}_t{{ parameter }}">Access to {{
                        config['opportunities'][opportunity]['name']
                        }} (Nearest {{
                        parameter }})</option>
                    {% endfor %}
                    {% endif %}
                    {% endfor %}
                </select>
            </p>
            <div id="results-map"></div>
        </div>
    </div>
    <div class="pure-g">
        <div class="pure-u-1">
            <h2>Scenario Comparisons</h2>
            <p>In this section, we compare the two sencarios analyzed. </p>
            {% for key, value in config['opportunities'].items() %}
            <h3>{{ config['opportunities'][key]['name'] }}</h3>
            <p>{{ config['opportunities'][key]['description'] }}</p>
            {% if config['opportunities'][key]['method'] == 'cumulative' %}
            <p>Here are the weighted average results of access to {{ config['opportunities'][key]['name'].lower() }}
                compared across various demographic groups. Keep in mind that this is a cumulative measure, where
                <b>higher</b> values are typically better.
            </p>
            {% else %}
            <p>Here are the results of access to {{ config['opportunities'][key]['name'].lower() }} compared across
                various demographic groups. Keep in mind that this is a travel time measure, where <b>lower</b> values
                are typically better.</p>
            {% endif %}
            {% for parameter in config['opportunities'][key]['parameters'] %}
            <div class="pure-u-1">
                {% if config['opportunities'][key]['method'] == 'cumulative' %}
                <div id="{{ key }}_c{{ parameter }}" class="result-chart"></div>
                {% else %}
                <div id="{{ key }}_t{{ parameter }}" class="result-chart"></div>
                {% endif %}
            </div>
            {% endfor %}
            {% endfor %}
        </div>
    </div>
    <div class="pure-g">
        <div class="pure-u-1">
            <h2>Unreachable Destinations</h2>
            <p>Uncreachable destinations are those which cannot be reached in the specified maximum travel time of 2
                hours. For
                travel time measures, a value of {{ config["infinity_value"] }} minutes was used for locations with
                excessive
                travel times. Here we plot for each destination the number of people in each demographic group who
                cannot reach
                any of a specified destination.</p>
            {% for key, value in config['opportunities'].items() %}
            {% if config['opportunities'][key]['method'] == 'travel_time' %}
            <h3>{{ config['opportunities'][key]['name'] }}</h3>
            {% for parameter in config['opportunities'][key]['parameters'] %}
            <div class="pure-u-1">

                <div id="{{ key }}_t{{ parameter }}-unreachable" class="result-chart"></div>
            </div>
            {% endfor %}
            {% endif %}
            {% endfor %}
            <h2>Notes</h2>
            <p>Things that could go here:
            <ul>
                <li>Any relevant papers or documentation?</li>
                <li>Detailed methodology outline?</li>
                <li>Other specific things to note</li>
            </ul>
            </p>
        </div>
    </div>
    <div class="pure-g no-print">
        <div class="pure-u-1">
            <h2>Data Downloads</h2>
            <p>For additional analysis using the computed metrics, you can download the various datasets generated by
                the analysis in tabular and spatial format. They are described and linked below.</p>
            <p>The datasets use a consistent format to capture the opportunity, method, parameter, and scenario
                measured. This is communicated in the format <code>A_BC_D</code>, where:
            <ul>
                <li>
                    <code>A</code> indicates the destination provided in the columns of the input file (e.g.
                    <code>hospitals</code>),
                </li>
                <li>
                    <code>B</code> indicates whether the measurement method is cumulative (<code>c</code>) or travel
                    time (<code>t</code>),
                </li>
                <li><code>C</code> indicates the parameter value (e.g. 45 minutes or 3rd closest destination), and</li>
                <li><code>D</code> indicates the scenario: 0 for the first scenario, 1 for the second, and 1-0 is the
                    difference between the two.</li>
            </ul>
            </p>
            <p>
            <ul>
                <li>
                    <p><b>Population Summaries</b> contain the weighted averages for each metric and parameter across
                        the demographic groups. The <code>metric</code> column follows the convention outlined above,
                        and subsequent columns indicate specific demographic groups. You can find a reference for these
                        in the <a href="/guide#demographics">user guide</a>.
                    </p>
                    <p><a class="pure-button pure-button-primary" href="/cache/{{analysis_id}}/summary.csv">Download
                            Summary Data</a></p>

                </li>
                <li>
                    <p><b>Comparison Data</b> contains block group level metrics for each scenario as well as their
                        difference. The first column of the dataset (<code>bg_id</code>) indicates the 12-digit block
                        group ID. Subsequent columns indicate the metric and scenario information following the
                        convention described above. Note that this dataset covers the entire analysis area, not just the
                        impact area.</p>
                    <p><a class="pure-button pure-button-primary" href="/cache/{{analysis_id}}/compared.csv">Download
                            Comparison Data</a></p>
                </li>
                <li>
                    <p><b>Demographic Data</b> contains block group level demographic counts for each demographic
                        groups within the impact area specified. The <i>last</i> column of the dataset
                        (<code>bg_id</code>) indicates the 12-digit block group ID. Other columns indicate specific
                        demographic groups. You can find a reference for these in the <a href="/guide#demographics">user
                            guide</a>.</p>
                    <p><a class="pure-button pure-button-primary"
                            href="/cache/{{analysis_id}}/demographics.csv">Download Demographic Data</a></p>
                </li>
                <li>
                    <p><b>Unreachable Data</b> contains a count of the number of people in each demographic group who
                        cannot reach the specified nth closest travel time measure. The <code>metric</code> column
                        contains the opportunity, method, and parameter information as described above, while the
                        <code>scenario</code> indicates the scenario value as described above. You can find a reference
                        for these in the <a href="/guide#demographics">user guide</a>.
                    </p>
                    <p><a class="pure-button pure-button-primary" href="/cache/{{analysis_id}}/unreachable.csv">Download
                            Unreachable Data</a></p>
                </li>
                <li>
                    <p><b>Analysis Areas</b> contain the spatial areas for each block group in the study area. They are
                        in GeoJSON format, which can be easily read by GIS applications including QGIS.</p>
                    <p><a class="pure-button pure-button-primary"
                            href="/cache/{{analysis_id}}/analysis_areas.geojson">Download
                            Analysis Areas</a></p>
                </li>
                <li>
                    <p><b>Analysis Centroids</b> contain the point-level centroids used to represent the origins and
                        destinations for each block group area. These centroids can be useful for detecting potential
                        anomalies or odd results, or for visualizing in a more concise format. <b>Note: </b> the block
                        group ID in this dataset is indicated by the column <code>id</code>. The data are in GeoJSON
                        format, which can be easily read by GIS applications including QGIS.</p>
                    <p><a class="pure-button pure-button-primary"
                            href="/cache/{{analysis_id}}/analysis_areas.geojson">Download
                            Analysis Centroids</a></p>
                </li>
                <li>
                    <p><b>Travel Time Matrices</b> contain the median transit travel time between each pair of block
                        groups across the study area. block group level demographic counts for each demographic
                        groups within the impact area specified. <b>Note: </b> these files are quite large, and may not
                        be easily opened in a typical spreadsheet editor.
                    <p><a class="pure-button pure-button-primary" href="/cache/{{analysis_id}}/matrix0.csv">Download
                            Travel Time Matrix for {{ config['scenarios'][0]['name'] }}</a></p>
                    <p><a class="pure-button pure-button-primary" href="/cache/{{analysis_id}}/matrix1.csv">Download
                            Travel Time Matrix for {{ config['scenarios'][1]['name'] }}</a></p>
                </li>
            </ul>
            </p>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/d3.v6.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/d3-array.v2.min.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/leaflet.js') }}"></script>
<script src="{{ url_for('static', filename='js/leaflet.ajax.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/results.js') }}" defer></script>
{% endblock %}